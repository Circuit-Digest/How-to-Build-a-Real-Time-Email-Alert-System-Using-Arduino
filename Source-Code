#include <WiFiS3.h>
#include <DHT.h>

/* ================= DHT SENSOR ================= */
#define DHTPIN 2
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

/* ================= WIFI DETAILS ================= */
const char* ssid = "yourssid";
const char* password = "password";

/* ================= EMAIL API DETAILS ================= */
const char* host = "www.circuitdigest.cloud";
const int port = 443;
const char* apiKey = "yourapikey";
const char* toEmail = "your regis mailid";
const int templateID = 1001;

/* ================= SETTINGS ================= */
const float TEMP_THRESHOLD = 30.0;
const unsigned long READ_INTERVAL = 2000;  // 2 seconds
const unsigned long RETRY_DELAY = 10000;   // 10 seconds after failed email

/* ================= FLAGS ================= */
bool emailSent = false;
unsigned long lastReadTime = 0;
unsigned long lastEmailAttempt = 0;

/* ================= SEND EMAIL ================= */
bool sendEmail(float temp, float hum) {
  WiFiSSLClient client;
  
  Serial.println("\nğŸ“§ Connecting to server...");
  
  // WiFiSSLClient on UNO R4 doesn't need setInsecure() - it handles SSL automatically
  
  if (!client.connect(host, port)) {
    Serial.println("âŒ HTTPS connection failed");
    return false;
  }

  /* -------- BUILD COMPLETE JSON PAYLOAD -------- */
  char payload[512];
  
  snprintf(payload, sizeof(payload),
    "{"
    "\"to_email\":\"%s\","
    "\"template_id\":%d,"
    "\"variables\":{"
      "\"subject\":\"Temperature Alert from DHT11 Sensor\","
      "\"title\":\"Temperature Threshold Exceeded!\","
      "\"description\":\"Your DHT11 sensor detected a temperature above %.1fÂ°C.\","
      "\"var1\":\"DHT11 Sensor Reading\","
      "\"var2\":\"Temp: %.1fÂ°C | Humidity: %.0f%%\""
    "}}",
    toEmail,
    templateID,
    TEMP_THRESHOLD,
    temp,
    hum
  );

  /* -------- SEND HTTP REQUEST -------- */
  client.println("POST /api/v1/email/send HTTP/1.1");
  client.print("Host: "); client.println(host);
  client.print("Authorization: "); client.println(apiKey);
  client.println("Content-Type: application/json");
  client.print("Content-Length: "); client.println(strlen(payload));
  client.println("Connection: close");
  client.println();
  client.println(payload);

  /* -------- DEBUG: Print payload -------- */
  Serial.println("ğŸ“¤ Sending payload:");
  Serial.println(payload);

  /* -------- WAIT FOR RESPONSE -------- */
  unsigned long timeout = millis();
  while (!client.available()) {
    if (millis() - timeout > 10000) {
      Serial.println("âŒ Server timeout");
      client.stop();
      return false;
    }
  }

  /* -------- READ AND PARSE RESPONSE -------- */
  bool success = false;
  Serial.println("\nğŸ“¨ Server response:");
  
  while (client.available()) {
    String line = client.readStringUntil('\n');
    Serial.println(line);
    
    // Check for success indicators
    if (line.indexOf("200 OK") >= 0 || line.indexOf("\"success\":true") >= 0) {
      success = true;
    }
  }

  client.stop();
  
  if (success) {
    Serial.println("\nâœ… Email sent successfully!");
  } else {
    Serial.println("\nâš ï¸ Email may have failed - check response above");
  }
  
  return success;
}

/* ================= SETUP ================= */
void setup() {
  Serial.begin(9600);
  delay(1000);
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘   DHT11 Temperature Alert System      â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  // Initialize DHT sensor
  Serial.println("ğŸŒ¡ï¸  Initializing DHT11 sensor...");
  dht.begin();
  delay(2000);  // DHT11 needs startup time
  Serial.println("âœ… DHT11 ready\n");

  // Connect to WiFi
  Serial.println("ğŸ“¡ Connecting to WiFi...");
  Serial.print("SSID: ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  Serial.println();
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("âœ… WiFi connected successfully!");
    Serial.print("ğŸ“ IP Address: ");
    Serial.println(WiFi.localIP());
    Serial.print("ğŸ“¶ Signal Strength: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
  } else {
    Serial.println("âŒ WiFi connection failed!");
    Serial.println("âš ï¸  System will continue trying to reconnect...");
  }
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘         Monitoring Started            â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.print("ğŸ¯ Alert Threshold: ");
  Serial.print(TEMP_THRESHOLD);
  Serial.println(" Â°C");
  Serial.print("â±ï¸  Reading Interval: ");
  Serial.print(READ_INTERVAL / 1000);
  Serial.println(" seconds\n");
  
  Serial.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
}

/* ================= LOOP ================= */
void loop() {
  unsigned long currentMillis = millis();
  
  // Non-blocking delay for sensor readings
  if (currentMillis - lastReadTime < READ_INTERVAL) {
    return;
  }
  lastReadTime = currentMillis;

  /* -------- CHECK WIFI CONNECTION -------- */
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âš ï¸  WiFi disconnected - attempting reconnect...");
    WiFi.begin(ssid, password);
    delay(5000);
    return;
  }

  /* -------- READ SENSOR DATA -------- */
  float humidity = dht.readHumidity();
  float temperature = dht.readTemperature();

  if (isnan(humidity) || isnan(temperature)) {
    Serial.println("âŒ Failed to read from DHT11 sensor");
    Serial.println("   Check wiring and connections\n");
    return;
  }

  /* -------- DISPLAY READINGS -------- */
  Serial.print("ğŸŒ¡ï¸  Temperature: ");
  Serial.print(temperature, 1);
  Serial.print(" Â°C  |  ğŸ’§ Humidity: ");
  Serial.print(humidity, 0);
  Serial.print(" %  |  Status: ");

  /* -------- EMAIL ALERT LOGIC -------- */
  if (temperature > TEMP_THRESHOLD) {
    Serial.print("ğŸš¨ HIGH ALERT");
    
    // Send email if not already sent and retry delay has passed
    if (!emailSent && (currentMillis - lastEmailAttempt > RETRY_DELAY)) {
      Serial.println("\n   â””â”€> Temperature exceeded threshold!");
      Serial.print("   â””â”€> Sending email alert...");
      
      lastEmailAttempt = currentMillis;
      
      if (sendEmail(temperature, humidity)) {
        emailSent = true;
        Serial.println("   â””â”€> âœ… Alert email delivered");
      } else {
        Serial.println("   â””â”€> âš ï¸  Email delivery failed, will retry");
      }
    } else if (emailSent) {
      Serial.println(" (Email already sent)");
    } else {
      Serial.println(" (Waiting for retry delay)");
    }
  } else {
    Serial.println("âœ… NORMAL");
    
    // Reset email flag when temperature returns to normal
    if (emailSent) {
      emailSent = false;
      Serial.println("   â””â”€> Temperature normalized - alert reset");
    }
  }
  
  Serial.println();
} 
